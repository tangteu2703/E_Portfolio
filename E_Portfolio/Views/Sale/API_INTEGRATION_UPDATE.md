# API Integration Update - POS System

## ‚úÖ ƒê√£ c·∫≠p nh·∫≠t API calls theo chu·∫©n d·ª± √°n

### üîÑ Thay ƒë·ªïi ch√≠nh

ƒê√£ chuy·ªÉn t·ª´ `fetch()` sang s·ª≠ d·ª•ng `apiHelper` th·ªëng nh·∫•t v·ªõi to√†n b·ªô d·ª± √°n.

---

## üìù Pattern API Calls

### ‚úÖ C≈® (fetch)
```javascript
const response = await fetch('/Sale/GetProducts');
const data = await response.json();
if (data.success) {
    // handle success
}
```

### ‚úÖ M·ªöI (apiHelper)
```javascript
await apiHelper.callApi('/Sale/GetProducts', 'GET', null,
    function (res) {
        var products = Array.isArray(res.data) ? res.data : [];
        // handle success
    },
    function (err) {
        console.error("L·ªói:", err);
        toastr.warning('Th√¥ng b√°o l·ªói');
    });
```

---

## üîß Chi ti·∫øt c·∫≠p nh·∫≠t

### 1. **Load Products**

```javascript
// ‚ùå OLD
async function loadProducts() {
    const response = await fetch('/Sale/GetProducts');
    const data = await response.json();
    allProducts = data.data;
}

// ‚úÖ NEW
async function loadProducts() {
    try {
        await apiHelper.callApi('/Sale/GetProducts', 'GET', null,
            function (res) {
                allProducts = Array.isArray(res.data) ? res.data : [];
                renderProducts(allProducts, '#productGrid');
            },
            function (err) {
                console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", err);
                toastr.warning('Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m, th·ª≠ l·∫°i sau.');
            });
    } catch (error) {
        console.error('Error loading products:', error);
    }
}
```

### 2. **Load Categories**

```javascript
// ‚úÖ NEW
async function loadCategories() {
    try {
        await apiHelper.callApi('/Sale/GetCategories', 'GET', null,
            function (res) {
                var categories = Array.isArray(res.data) ? res.data : [];
                renderCategoryFilter(categories);
            },
            function (err) {
                console.error("L·ªói t·∫£i danh m·ª•c:", err);
            });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}
```

### 3. **Filter by Category**

```javascript
// ‚úÖ NEW
async function filterByCategory(categoryId) {
    if (!categoryId) {
        renderProducts(allProducts, '#productGrid');
        return;
    }

    try {
        await apiHelper.callApi(`/Sale/GetProductsByCategory?categoryId=${categoryId}`, 'GET', null,
            function (res) {
                var products = Array.isArray(res.data) ? res.data : [];
                renderProducts(products, '#productGrid');
            },
            function (err) {
                console.error("L·ªói l·ªçc s·∫£n ph·∫©m theo danh m·ª•c:", err);
                toastr.warning('Kh√¥ng th·ªÉ l·ªçc s·∫£n ph·∫©m.');
            });
    } catch (error) {
        console.error('Error filtering by category:', error);
    }
}
```

### 4. **Create Order (POST)**

```javascript
// ‚úÖ NEW
async function completePayment() {
    const orderData = {
        orderNumber: generateOrderNumber(),
        customerName: $('#customerInfo').val() || 'Kh√°ch l·∫ª',
        customerPhone: '',
        items: cart,
        subtotal: subtotal,
        discount: discount,
        total: total,
        paymentMethod: $('#paymentMethod').val(),
        status: 'Completed',
        createdAt: new Date().toISOString()
    };

    try {
        await apiHelper.post('/Sale/CreateOrder', orderData,
            function (res) {
                // Success callback
                const finalOrderNumber = res.orderNumber || orderData.orderNumber;
                
                Swal.fire({
                    title: 'Thanh to√°n th√†nh c√¥ng!',
                    html: `...`,
                    icon: 'success'
                });

                // Clear cart
                cart = [];
                $('#customerInfo').val('');
                updateCart();
            },
            function (err) {
                console.error("L·ªói t·∫°o ƒë∆°n h√†ng:", err);
                toastr.error('Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng, vui l√≤ng th·ª≠ l·∫°i.');
            });
    } catch (error) {
        console.error('Error completing payment:', error);
        toastr.error('C√≥ l·ªói x·∫£y ra khi thanh to√°n.');
    }
}
```

### 5. **Client-side Search (Real-time)**

```javascript
// ‚úÖ NEW - T√¨m ki·∫øm client-side (instant)
$('#searchProduct').on('input', function () {
    const searchTerm = $(this).val();
    
    if (searchTerm.trim() === '') {
        renderProducts(allProducts, '#productGrid');
    } else {
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            p.code.toLowerCase().includes(searchTerm.toLowerCase())
        );
        renderProducts(filtered, '#productGrid');
    }
});
```

---

## üìö Controller Updates

### Search Products API

```csharp
/// <summary>
/// Search products
/// </summary>
[HttpGet]
public IActionResult SearchProducts(string keyword)
{
    try
    {
        if (string.IsNullOrWhiteSpace(keyword))
        {
            return Json(new { success = true, data = ProductSeedData.GetProducts() });
        }

        var allProducts = ProductSeedData.GetProducts();
        var filtered = allProducts.Where(p =>
            p.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase) ||
            p.Code.Contains(keyword, StringComparison.OrdinalIgnoreCase) ||
            (p.Description != null && p.Description.Contains(keyword, StringComparison.OrdinalIgnoreCase))
        ).ToList();

        return Json(new { success = true, data = filtered });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error searching products");
        return Json(new { success = false, message = "C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm s·∫£n ph·∫©m" });
    }
}
```

---

## üé® UI Updates

### Toastr Integration

**_Layout_Sale.cshtml** - Added Toastr:

```html
<!-- Toastr CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
```

### Toast Function Update

```javascript
// ‚úÖ NEW - Use toastr instead of SweetAlert2 toast
function showToast(type, message) {
    switch (type) {
        case 'success':
            toastr.success(message);
            break;
        case 'error':
            toastr.error(message);
            break;
        case 'warning':
            toastr.warning(message);
            break;
        case 'info':
            toastr.info(message);
            break;
        default:
            toastr.info(message);
    }
}
```

---

## üìä API Endpoints Summary

| Endpoint | Method | Description | Response |
|----------|--------|-------------|----------|
| `/Sale/GetProducts` | GET | L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m | `{ success: true, data: Product[] }` |
| `/Sale/GetCategories` | GET | L·∫•y danh m·ª•c | `{ success: true, data: Category[] }` |
| `/Sale/GetProductsByCategory?categoryId={id}` | GET | L·ªçc theo danh m·ª•c | `{ success: true, data: Product[] }` |
| `/Sale/GetBestSellers` | GET | S·∫£n ph·∫©m b√°n ch·∫°y | `{ success: true, data: Product[] }` |
| `/Sale/SearchProducts?keyword={text}` | GET | T√¨m ki·∫øm s·∫£n ph·∫©m | `{ success: true, data: Product[] }` |
| `/Sale/CreateOrder` | POST | T·∫°o ƒë∆°n h√†ng | `{ success: true, orderNumber: string }` |
| `/Sale/GetOrderHistory?page={n}&pageSize={n}` | GET | L·ªãch s·ª≠ ƒë∆°n | `{ success: true, data: Order[], total: int }` |
| `/Sale/GetHeldOrders` | GET | ƒê∆°n h√†ng gi·ªØ | `{ success: true, data: Order[] }` |

---

## ‚úÖ Benefits

### 1. **Consistency**
- T·∫•t c·∫£ API calls theo chu·∫©n d·ª± √°n
- Error handling th·ªëng nh·∫•t
- Notification style ƒë·ªìng nh·∫•t (toastr)

### 2. **Error Handling**
```javascript
// T·ª± ƒë·ªông handle error v·ªõi callback
function (err) {
    console.error("L·ªói:", err);
    toastr.warning('Th√¥ng b√°o l·ªói cho user');
}
```

### 3. **Loading State**
```javascript
// apiHelper t·ª± ƒë·ªông handle loading indicator
await apiHelper.callApi(...);
```

### 4. **Type Safety**
```javascript
// Lu√¥n check array
var products = Array.isArray(res.data) ? res.data : [];
```

---

## üîç Testing Checklist

### Frontend
- [x] Load products hi·ªÉn th·ªã 25 items
- [x] Load categories v√†o dropdown
- [x] Filter by category ho·∫°t ƒë·ªông
- [x] Search real-time (client-side)
- [x] Add to cart v·ªõi data ƒë√∫ng
- [x] Create order call API
- [x] Toastr notifications hi·ªÉn th·ªã
- [x] Error handling khi API fail

### Backend
- [x] GetProducts return 25 items
- [x] GetCategories return 7 categories
- [x] GetProductsByCategory filter ƒë√∫ng
- [x] SearchProducts t√¨m ki·∫øm ch√≠nh x√°c
- [x] CreateOrder log th√¥ng tin

---

## üéØ Next Steps (Optional)

### Phase 1: Real Database
```csharp
// Replace seed data v·ªõi database queries
public IActionResult GetProducts()
{
    var products = _productRepository.GetAll();
    return Json(new { success = true, data = products });
}
```

### Phase 2: Authentication
```csharp
[Authorize]
[PermissionFilter("POS_ACCESS")]
public IActionResult CreateOrder([FromBody] OrderModel orderData)
{
    // Save order with user info
}
```

### Phase 3: Real-time Updates
```javascript
// SignalR for real-time stock updates
connection.on("StockUpdated", function (productId, newStock) {
    updateProductStock(productId, newStock);
});
```

---

## üìù Code Examples

### Complete Flow Example

```javascript
// 1. Page Load
$(document).ready(function () {
    loadProducts();    // Load all products
    loadCategories();  // Load category filter
    setupEventListeners();
    updateCart();
});

// 2. User selects category
$('#categoryFilter').on('change', function () {
    const categoryId = $(this).val();
    filterByCategory(categoryId);  // Filter products
});

// 3. User searches
$('#searchProduct').on('input', function () {
    const searchTerm = $(this).val();
    // Client-side filter (instant)
    const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    renderProducts(filtered, '#productGrid');
});

// 4. User adds to cart
function addToCartById(productId) {
    const product = allProducts.find(p => p.id === productId);
    addToCart(product);
    showToast('success', 'ƒê√£ th√™m v√†o gi·ªè h√†ng!');
}

// 5. User completes payment
async function completePayment() {
    await apiHelper.post('/Sale/CreateOrder', orderData,
        function (res) {
            showToast('success', 'Thanh to√°n th√†nh c√¥ng!');
            cart = [];
            updateCart();
        },
        function (err) {
            showToast('error', 'C√≥ l·ªói x·∫£y ra!');
        });
}
```

---

## üéâ Summary

‚úÖ **ƒê√£ ho√†n th√†nh**:
- Chuy·ªÉn to√†n b·ªô API calls sang `apiHelper`
- Th√™m Toastr cho notifications
- Implement search v·ªõi StringComparison
- Client-side filter cho UX t·ªët h∆°n
- Error handling ƒë·∫ßy ƒë·ªß
- Array safety checks
- Consistent code style

üöÄ **Ready to use!**

---

**Updated**: October 27, 2025  
**Version**: 2.0.0  
**Status**: ‚úÖ Production Ready

